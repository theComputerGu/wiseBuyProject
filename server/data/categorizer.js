const fs = require("fs");

// =======================
// Load data
// =======================
const products = JSON.parse(
  fs.readFileSync("wisebuy.products.categorized2.json", "utf8")
);

// =======================
// Normalize helper
// =======================
function normalize(text = "") {
  return text
    .toLowerCase()
    .replace(/[\"׳״]/g, "")
    .replace(/[^\p{L}\p{N}\s%]/gu, " ")
    .replace(/\s+/g, " ")
    .trim();
}

// =======================
// RULES (ORDER MATTERS)
// =======================
const RULES = [

   // =================================================
  // חטיפים וממתקים
  // =================================================
  {
    category: "חטיפים וממתקים",
    keywords: [
      "שוקולד","חטיף","חטיפים","ממתק",
      "וופל","ביסלי","במבה","דוריטוס",
      "צ יפס","צ'יפס","פופקורן",
      "קרמל","טופי","לינדט","לינד",
      "מיני","חטיפי","סניקרס","טוויקס","מלטיזרס","פיסטוק","שוק","חמצוצים","גרעיני","בונבוניירה","קורני","בוטנ","איירוויבז","סקיטלס","מסטיק","אורביט","קינדר","סוכריות","גומי","מרשמלו"
    ]
  },

  // =================================================
  // פארם ותינוקות (כ־25 חוקים)
  // =================================================
  {
    category: "פארם ותינוקות",
    keywords: [
      "שמפו","מרכך","קרם","קרם גוף","קרם ידיים",
      "תחליב","תח","אל סבון","אלסבון",
      "ג׳ל","ג'ל","ג'לי","לחות","עור","גוף","שיער",
      "שמן לשיער","שמן גוף","מסכה","מסיר איפור",
      "מים מיסלר","מי פנים","חלב פנים","טונר",
      "דאודורנט","דאורדורנט","ספריי גוף",
      "שיניים","משחת שיניים","מברשת שיניים",
      "טמפונים","טמפון","תחבושת","פד","מגן",
      "סקין","קלינקס","וזלין","גונסון","johnson",
      "ניוטרוג","נוטרוג","לוריאל","גרנייה",
      "אלביב","פנטן","אולטרה","colgate","oral",
      "סימילאק","תרחיץ","פילינג","דנטלי","דאו","או בה","טמפוני","קולגייט","סטיק","גילוח","לבלו","ניוואה","שפתיים","בליסטקס","שייב","גילוח","after shave"
    ]
  },

  // =================================================
  // נקיון (כ־12 חוקים)
  // =================================================
  {
    category: "נקיון",
    keywords: [
      "ניקוי","חומר ניקוי","אקונומיקה",
      "מדיח","טבליות מדיח","רצפות","ספריי ניקוי",
      "פיניש","finish","סמרטוט","סקוץ",
      "טישו","נייר טואלט","נייר סופג",
      ,"פיירי","אורל בי","שקיות אשפה","מרכך כביסה","אבקת כביסה"
    ]
  },

  // =================================================
  // הכל לבית (כ־12 חוקים)
  // =================================================
  {
    category: "הכל לבית",
    keywords: [
      "נרות","כוס","צלחת","קערה","סכו ם","מזלג","כפית",
      "קופסא","קופסה","קופסאות",
      "נייר אפייה","ניילון","שקיות",
      "נייר כסף","חד פעמי","חד פעמי",
      "כביסה","מגבות","מגבת","מטלית","ספוג"
    ]
  },

  // =================================================
  // קפואים
  // =================================================
  {
    category: "קפואים",
    keywords: [
      "קפוא","קפואה","מוקפא",
      ,"שלגון","גלידת","הרינג","קוויאר","בלינצ","מצונן","אפונה קפואה","תירס קפוא","ירקות קפואים"
    ]
  },

  // =================================================
  // עוף בשר ודגים
  // =================================================
  {
    category: "עוף בשר ודגים",
    keywords: [
      "עוף","פרגית","שוק עוף","כנפיים",
      "בשר","בקר","אנטריקוט","אסאדו",
      "קבב","המבורגר","קציצות",
      ,"סלמון","טונה","פילה","אמנון","בקלה"
    ]
  },

  // =================================================
  // מוצרי קירור וביצים
  // =================================================
  {
    category: "מוצרי קירור וביצים",
    keywords: [
      "חלב","חלב 3","חלב 1","חלב עיזים",
      "גבינה","גבינת","קוטג","יוגורט",
      "שמנת","חמאה","מרגרינה",
      "קירי","ברי","גאודה","מוצרלה",
      "מעדן","ביצה","ביצים"
    ]
  },

  // =================================================
  // מעדנייה
  // =================================================
  {
    category: "מעדנייה סלטים ונקניקים",
    keywords: [
      "חומוס","טחינה","מטבל","ממרח",
      "סלט","סלטים","כרוב","חציל",
      "נקניק","פסטרמה","סלמי","קבנוס"
    ]
  },

  // =================================================
  // שימורים / בישול / תבלינים (כ־15 חוקים)
  // =================================================
  {
    category: "שימורים בישול ואפייה",
    keywords: [
      "שימורים","תירס","אפונה","שעועית",
      "רסק","עגבניות","קטשופ","חרדל",
      "רוטב","סויה","צילי","טבסקו",
      "ברביקיו","מיונז",
      "קמח","סוכר","מלח","פלפל","פפריקה",
      "כמון","כורכום","קינמון","תבלין",
      "שמרים","אבקת אפייה","וניל",
      "זיתים","אורז","ספגטי","פסטה","שמן קנולה","שמן זית","חמאת בוטנים","סקיפי"
    ]
  },

  // =================================================
  // דגנים / חטיפי אנרגיה
  // =================================================
  {
    category: "דגנים",
    keywords: [
      "דגני","דגנים","דגני בוקר",
      "קורנפלקס","קראנץ","פיטנס",
      "פייבר","נייטשר","גרנולה",
      "שיבולת","שיבולת שועל","oats"
    ]
  },

  // =================================================
  // לחמים / עוגות
  // =================================================
  {
    category: "לחמים עוגות ועוגיות",
    keywords: [
      "לחם","לחמניה","חלה","פיתה",
      "עוגה","עוגיות","עוגיית",
      "לוטוס","ביסקוויט","עוגת","מאפה"
    ]
  },


  // =================================================
  // ירקות ופירות
  // =================================================
  {
    category: "ירקות ופירות",
    keywords: [
      "תפוח","בננה","אגס","אפרסק",
      "תפוז","קלמנטינה","לימון",
      "עגבניה","מלפפון","פלפל","חסה",
      "בצל","שום","תפוח אדמה",
      "דובדנים","דובדבן","אוכמניות","פרי","ירק","אבוקדו","קוקוס"
    ]
  },

  // =================================================
  // משקאות ויין
  // =================================================
  {
    category: "משקאות ויין",
    keywords: [
      "מים","מים מינרליים","מי סודה",
      "מיץ","נקטר","שתיה","משקה",
      "קולה","פפסי","ספרייט","פאנטה",
      "קפה","נס קפה","אספרסו",
      "תה","חליטה","קקאו",
      "מונסטר","גין","סומרסבי","קוקטייל","בלו נאן","חליטת","יין","בירה","וודקה","וויסקי"
    ]
  },

  // =================================================
  // בריאות ותזונה
  // =================================================
  {
    category: "בריאות ותזונה",
    keywords: [
      "ללא סוכר","דל שומן","חלבון",
      "ויטמין","תוסף","בריאות",
      "תזונה","דיאט","טבעי","אורגני"
    ]
  },

  // =================================================
  // פנאי ובעלי חיים
  // =================================================
  {
    category: "פנאי ובעלי חיים",
    keywords: [
      "כלב","חתול","חיות","מזון לכלב",
      "מזון לחתול","צעצוע","חול לחתולים",
      "רצועה","קערת אוכל","חטיף לכלב"
    ]
  }
];

// =======================
// Categorizer
// =======================
function categorize(title) {
  const t = normalize(title);
  for (const rule of RULES) {
    if (rule.keywords.some(k => t.includes(k))) {
      return rule.category;
    }
  }
  return "אחר";
}

// =======================
// Run
// =======================
const stats = {};
const updated = products.map(p => {
  const category = categorize(p.title);
  stats[category] = (stats[category] || 0) + 1;
  return { ...p, category };
});

fs.writeFileSync(
  "wisebuy.products.categorized3.json",
  JSON.stringify(updated, null, 2)
);

console.log("✅ Categorization complete");
console.table(stats);
